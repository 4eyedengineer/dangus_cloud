#!/bin/bash
# Dangus Cloud Development Helper
# Usage: ./dev [command]

set -e
cd "$(dirname "$0")"

case "${1:-help}" in
  up|start)
    if [[ "$2" == "-d" || "$2" == "--detach" ]]; then
      docker compose up -d
      echo "Started: http://192.168.1.124:5173"
    else
      docker compose up
    fi
    ;;
  down|stop)
    docker compose down
    ;;
  logs)
    docker compose logs -f ${2:-}
    ;;
  restart)
    docker compose restart ${2:-}
    ;;
  rebuild)
    if [[ "$2" == "-d" || "$2" == "--detach" ]]; then
      docker compose up -d --build
      echo "Rebuilt: http://192.168.1.124:5173"
    else
      docker compose up --build
    fi
    ;;
  ps)
    docker compose ps
    ;;
  harbor)
    ./scripts/run-harbor-images.sh
    ;;
  pull)
    ./scripts/run-harbor-images.sh --pull
    ;;
  db)
    psql -h 192.168.1.124 -U dangus -d dangus_cloud
    ;;
  token)
    echo "Generating new k3s token..."
    TOKEN=$(kubectl create token dangus-backend -n dangus-cloud --duration=8760h)
    echo "KUBERNETES_TOKEN=$TOKEN"
    echo ""
    echo "Add to .env file to enable k3s deployments"
    ;;
  auth)
    if [ -z "$2" ]; then
      if [ -f .dev-session ]; then
        echo "Current session cookie:"
        cat .dev-session
      else
        echo "No session cookie set. Usage: ./dev auth <cookie>"
      fi
    else
      echo "$2" > .dev-session
      echo "Session cookie saved to .dev-session"
    fi
    ;;
  status)
    echo "┌─────────────────────────────────────────┐"
    echo "│         DANGUS CLOUD STATUS             │"
    echo "└─────────────────────────────────────────┘"
    echo ""

    # Get stats
    STATS=$(curl -s http://192.168.1.124:3001/admin/stats)
    echo "Database:"
    echo "  Projects:    $(echo $STATS | python3 -c "import sys,json; print(json.load(sys.stdin)['stats']['projects'])")"
    echo "  Services:    $(echo $STATS | python3 -c "import sys,json; print(json.load(sys.stdin)['stats']['services'])")"
    echo "  Deployments: $(echo $STATS | python3 -c "import sys,json; print(json.load(sys.stdin)['stats']['deployments'])")"
    echo "  Users:       $(echo $STATS | python3 -c "import sys,json; print(json.load(sys.stdin)['stats']['users'])")"
    echo ""

    # Get health
    HEALTH=$(curl -s http://192.168.1.124:3001/admin/health)
    ORPHANS=$(echo $HEALTH | python3 -c "import sys,json; print(json.load(sys.stdin)['summary']['orphanedNamespaces'])")
    GHOSTS=$(echo $HEALTH | python3 -c "import sys,json; print(json.load(sys.stdin)['summary']['ghostProjects'])")
    HEALTHY=$(echo $HEALTH | python3 -c "import sys,json; print(json.load(sys.stdin)['healthy'])")

    if [ "$HEALTHY" == "True" ]; then
      echo "Health: ✓ All systems consistent"
    else
      echo "Health: ⚠ Issues detected"
      if [ "$ORPHANS" != "0" ]; then
        echo "  - $ORPHANS orphaned K8s namespace(s) (run: ./dev cleanup)"
      fi
      if [ "$GHOSTS" != "0" ]; then
        echo "  - $GHOSTS ghost project(s) in DB without K8s namespace"
      fi
    fi
    ;;
  cleanup)
    # Check for orphans first
    HEALTH=$(curl -s http://192.168.1.124:3001/admin/health)
    ORPHANS=$(echo $HEALTH | python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d['orphanedNamespaces']))")

    if [ "$ORPHANS" == "0" ]; then
      echo "✓ No orphaned namespaces to clean up"
      exit 0
    fi

    echo "Found $ORPHANS orphaned K8s namespace(s):"
    echo $HEALTH | python3 -c "import sys,json; [print(f\"  - {ns['name']}\") for ns in json.load(sys.stdin)['orphanedNamespaces']]"
    echo ""

    # Require session for cleanup
    if [ ! -f .dev-session ]; then
      echo "Error: Run ./dev auth <cookie> first (requires login)"
      exit 1
    fi
    SESSION_COOKIE="Cookie: session=$(cat .dev-session)"

    echo "Delete these namespaces? (type 'yes' to confirm)"
    read -r confirm
    if [ "$confirm" == "yes" ]; then
      RESULT=$(curl -s -X POST http://192.168.1.124:3001/admin/reconcile \
        -H "Content-Type: application/json" \
        -H "$SESSION_COOKIE" \
        -d '{"dryRun": false, "deleteOrphanedNamespaces": true, "confirm": "RECONCILE"}')

      SUCCESS=$(echo $RESULT | python3 -c "import sys,json; print(json.load(sys.stdin).get('success', False))")
      if [ "$SUCCESS" == "True" ]; then
        echo "✓ Cleanup complete"
      else
        echo "Cleanup result:"
        echo $RESULT | python3 -m json.tool
      fi
    else
      echo "Aborted."
    fi
    ;;
  *)
    cat <<EOF
Dangus Cloud Dev Commands:

  ./dev up [-d]     Start dev environment (-d for background)
  ./dev down        Stop all containers
  ./dev rebuild [-d] Rebuild and restart
  ./dev logs [svc]  Follow logs (optional: backend, frontend)
  ./dev ps          Show container status

  ./dev status      Show system health and stats
  ./dev cleanup     Delete orphaned K8s namespaces

  ./dev db          Connect to PostgreSQL
  ./dev token       Generate new k3s service account token
  ./dev auth [cookie] View/set session cookie

URLs:
  Frontend: http://192.168.1.124:5173
  Backend:  http://192.168.1.124:3001
EOF
    ;;
esac
