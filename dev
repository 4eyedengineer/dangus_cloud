#!/bin/bash
# Dangus Cloud Development Helper
# Usage: ./dev [command]

set -e
cd "$(dirname "$0")"

case "${1:-help}" in
  up|start)
    if [[ "$2" == "-d" || "$2" == "--detach" ]]; then
      docker compose up -d
      echo "Started: http://192.168.1.124:5173"
    else
      docker compose up
    fi
    ;;
  down|stop)
    docker compose down
    ;;
  logs)
    docker compose logs -f ${2:-}
    ;;
  restart)
    docker compose restart ${2:-}
    ;;
  rebuild)
    if [[ "$2" == "-d" || "$2" == "--detach" ]]; then
      docker compose up -d --build
      echo "Rebuilt: http://192.168.1.124:5173"
    else
      docker compose up --build
    fi
    ;;
  ps|status)
    docker compose ps
    ;;
  harbor)
    ./scripts/run-harbor-images.sh
    ;;
  pull)
    ./scripts/run-harbor-images.sh --pull
    ;;
  db)
    psql -h 192.168.1.124 -U dangus -d dangus_cloud
    ;;
  token)
    echo "Generating new k3s token..."
    TOKEN=$(kubectl create token dangus-backend -n dangus-cloud --duration=8760h)
    echo "KUBERNETES_TOKEN=$TOKEN"
    echo ""
    echo "Add to .env file to enable k3s deployments"
    ;;
  auth)
    if [ -z "$2" ]; then
      if [ -f .dev-session ]; then
        echo "Current session cookie:"
        cat .dev-session
      else
        echo "No session cookie set. Usage: ./dev auth <cookie>"
      fi
    else
      echo "$2" > .dev-session
      echo "Session cookie saved to .dev-session"
    fi
    ;;
  *)
    cat <<EOF
Dangus Cloud Dev Commands:

  ./dev up        Start dev environment (foreground, shows logs)
  ./dev up -d     Start detached (background)
  ./dev down      Stop all containers
  ./dev logs      Follow all logs (or: ./dev logs backend)
  ./dev restart   Restart all (or: ./dev restart frontend)
  ./dev rebuild   Rebuild and restart (foreground)
  ./dev rebuild -d  Rebuild detached
  ./dev ps        Show container status
  ./dev harbor    Run with Harbor production images
  ./dev pull      Pull latest Harbor images
  ./dev db        Connect to PostgreSQL
  ./dev token     Generate new k3s service account token
  ./dev auth      Show current session cookie
  ./dev auth <c>  Save session cookie for Playwright testing

URLs:
  Frontend: http://192.168.1.124:5173
  Backend:  http://192.168.1.124:3001

Note: Copy .env.example to .env and add KUBERNETES_TOKEN for k3s deployments
EOF
    ;;
esac
